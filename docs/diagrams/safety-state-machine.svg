<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 700" width="1000" height="700">
  <style>
    text { font-family: 'Source Sans 3', sans-serif; }
    .mono { font-family: 'Source Code Pro', monospace; }
  </style>

  <defs>
    <marker id="arrow-trans" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
      <path d="M0,0 L8,3 L0,6" fill="none" stroke="#64748b" stroke-width="1.5"/>
    </marker>
    <marker id="arrow-fault" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
      <path d="M0,0 L8,3 L0,6" fill="none" stroke="#dc2626" stroke-width="1.5"/>
    </marker>
  </defs>

  <!-- Background -->
  <rect width="1000" height="700" fill="#f8fafc" rx="4"/>

  <!-- Title -->
  <text x="500" y="28" text-anchor="middle" fill="#0f172a" font-size="16" font-weight="bold">Safety State Machine</text>

  <!-- ======= IDLE State ======= -->
  <rect x="60" y="80" width="140" height="56" rx="8" fill="#f1f5f9" stroke="#334155" stroke-width="2"/>
  <text x="130" y="104" text-anchor="middle" fill="#0f172a" font-size="13" font-weight="bold">IDLE</text>
  <text x="130" y="124" text-anchor="middle" fill="#64748b" font-size="10" class="mono">SSR = PID</text>

  <!-- ======= HEATING State ======= -->
  <rect x="300" y="80" width="140" height="56" rx="8" fill="#ffedd5" stroke="#334155" stroke-width="2"/>
  <text x="370" y="104" text-anchor="middle" fill="#0f172a" font-size="13" font-weight="bold">HEATING</text>
  <text x="370" y="124" text-anchor="middle" fill="#64748b" font-size="10" class="mono">SSR = PID</text>

  <!-- ======= READY State ======= -->
  <rect x="540" y="80" width="140" height="56" rx="8" fill="#d1fae5" stroke="#334155" stroke-width="2"/>
  <text x="610" y="104" text-anchor="middle" fill="#0f172a" font-size="13" font-weight="bold">READY</text>
  <text x="610" y="124" text-anchor="middle" fill="#64748b" font-size="10" class="mono">SSR = PID</text>

  <!-- ======= BREWING State ======= -->
  <rect x="780" y="80" width="160" height="56" rx="8" fill="#dbeafe" stroke="#334155" stroke-width="2"/>
  <text x="860" y="104" text-anchor="middle" fill="#0f172a" font-size="13" font-weight="bold">BREWING</text>
  <text x="860" y="124" text-anchor="middle" fill="#64748b" font-size="10" class="mono">Profile engine active</text>

  <!-- ======= STEAM State ======= -->
  <rect x="540" y="220" width="140" height="56" rx="8" fill="#fef3c7" stroke="#334155" stroke-width="2"/>
  <text x="610" y="244" text-anchor="middle" fill="#0f172a" font-size="13" font-weight="bold">STEAM</text>
  <text x="610" y="264" text-anchor="middle" fill="#64748b" font-size="10" class="mono">SSR = PID (steam)</text>

  <!-- ======= DONE State ======= -->
  <rect x="540" y="360" width="140" height="56" rx="8" fill="#d1fae5" stroke="#334155" stroke-width="2"/>
  <text x="610" y="384" text-anchor="middle" fill="#0f172a" font-size="13" font-weight="bold">DONE</text>
  <text x="610" y="404" text-anchor="middle" fill="#64748b" font-size="10">Shot summary</text>

  <!-- ======= FLUSHING State ======= -->
  <rect x="300" y="360" width="140" height="56" rx="8" fill="#e0f2fe" stroke="#334155" stroke-width="2"/>
  <text x="370" y="384" text-anchor="middle" fill="#0f172a" font-size="13" font-weight="bold">FLUSHING</text>
  <text x="370" y="404" text-anchor="middle" fill="#64748b" font-size="10" class="mono">Pump ON, valve cycle</text>

  <!-- ======= DESCALING State ======= -->
  <rect x="780" y="220" width="160" height="56" rx="8" fill="#ede9fe" stroke="#334155" stroke-width="2"/>
  <text x="860" y="244" text-anchor="middle" fill="#0f172a" font-size="13" font-weight="bold">DESCALING</text>
  <text x="860" y="264" text-anchor="middle" fill="#64748b" font-size="10" class="mono">Pump cycle program</text>

  <!-- ======= FAULT State ======= -->
  <rect x="300" y="520" width="400" height="70" rx="8" fill="#fee2e2" stroke="#dc2626" stroke-width="2"/>
  <text x="500" y="548" text-anchor="middle" fill="#991b1b" font-size="14" font-weight="bold">FAULT</text>
  <text x="500" y="568" text-anchor="middle" fill="#991b1b" font-size="11">All outputs OFF. Exit: power cycle or reset command.</text>
  <text x="500" y="582" text-anchor="middle" fill="#991b1b" font-size="10" class="mono">SSR=OFF, Pump=OFF, Valve=OFF</text>

  <!-- ======= Transitions ======= -->

  <!-- IDLE → HEATING -->
  <line x1="200" y1="108" x2="296" y2="108" stroke="#64748b" stroke-width="1.5" marker-end="url(#arrow-trans)"/>
  <text x="248" y="100" text-anchor="middle" fill="#64748b" font-size="9">temp &lt; set-2</text>

  <!-- HEATING → READY -->
  <line x1="440" y1="108" x2="536" y2="108" stroke="#64748b" stroke-width="1.5" marker-end="url(#arrow-trans)"/>
  <text x="488" y="100" text-anchor="middle" fill="#64748b" font-size="9">temp >= set-1</text>

  <!-- READY → BREWING -->
  <line x1="680" y1="108" x2="776" y2="108" stroke="#64748b" stroke-width="1.5" marker-end="url(#arrow-trans)"/>
  <text x="728" y="96" text-anchor="middle" fill="#64748b" font-size="9">brew ON +</text>
  <text x="728" y="106" text-anchor="middle" fill="#64748b" font-size="9">temp >= set-2</text>

  <!-- READY → STEAM -->
  <line x1="610" y1="136" x2="610" y2="216" stroke="#64748b" stroke-width="1.5" marker-end="url(#arrow-trans)"/>
  <text x="625" y="178" fill="#64748b" font-size="9">steam ON</text>

  <!-- READY → DESCALING -->
  <polyline points="680,125 730,170 860,170 860,216" fill="none" stroke="#64748b" stroke-width="1.5" marker-end="url(#arrow-trans)"/>
  <text x="790" y="165" fill="#64748b" font-size="9">descale cmd</text>

  <!-- BREWING → DONE -->
  <polyline points="940,120 960,120 960,388 684,388" fill="none" stroke="#64748b" stroke-width="1.5" marker-end="url(#arrow-trans)"/>
  <text x="968" y="260" fill="#64748b" font-size="9" transform="rotate(90,968,260)">shot done / switch OFF</text>

  <!-- STEAM → DONE -->
  <line x1="610" y1="276" x2="610" y2="356" stroke="#64748b" stroke-width="1.5" marker-end="url(#arrow-trans)"/>
  <text x="625" y="318" fill="#64748b" font-size="9">steam OFF</text>

  <!-- DESCALING → DONE -->
  <polyline points="860,276 860,388 684,388" fill="none" stroke="#64748b" stroke-width="1.5" marker-end="url(#arrow-trans)"/>
  <text x="790" y="382" fill="#64748b" font-size="9">done</text>

  <!-- DONE → IDLE (curves left and up) -->
  <polyline points="540,388 40,388 40,108 56,108" fill="none" stroke="#64748b" stroke-width="1.5" marker-end="url(#arrow-trans)"/>
  <text x="48" y="250" fill="#64748b" font-size="9" transform="rotate(-90,48,250)">timeout 3s</text>

  <!-- DONE → FLUSHING -->
  <line x1="540" y1="388" x2="444" y2="388" stroke="#64748b" stroke-width="1.5" marker-end="url(#arrow-trans)"/>
  <text x="492" y="380" text-anchor="middle" fill="#64748b" font-size="9">flush button</text>

  <!-- FLUSHING → IDLE -->
  <polyline points="300,388 130,388 130,140" fill="none" stroke="#64748b" stroke-width="1.5" marker-end="url(#arrow-trans)"/>
  <text x="140" y="280" fill="#64748b" font-size="9">done</text>

  <!-- Any → FAULT arrows (from multiple states) -->
  <!-- From IDLE -->
  <line x1="130" y1="136" x2="340" y2="516" stroke="#dc2626" stroke-width="1.5" stroke-dasharray="4,3" marker-end="url(#arrow-fault)"/>

  <!-- From HEATING -->
  <line x1="370" y1="136" x2="420" y2="516" stroke="#dc2626" stroke-width="1.5" stroke-dasharray="4,3" marker-end="url(#arrow-fault)"/>

  <!-- From READY -->
  <line x1="610" y1="136" x2="540" y2="516" stroke="#dc2626" stroke-width="1.5" stroke-dasharray="4,3" opacity="0.4"/>

  <!-- From BREWING -->
  <line x1="860" y1="136" x2="620" y2="516" stroke="#dc2626" stroke-width="1.5" stroke-dasharray="4,3" marker-end="url(#arrow-fault)"/>

  <!-- From STEAM -->
  <line x1="580" y1="276" x2="520" y2="516" stroke="#dc2626" stroke-width="1.5" stroke-dasharray="4,3" opacity="0.4"/>

  <!-- From DESCALING -->
  <line x1="860" y1="276" x2="640" y2="516" stroke="#dc2626" stroke-width="1.5" stroke-dasharray="4,3" opacity="0.4"/>

  <!-- ======= Fault conditions legend ======= -->
  <rect x="60" y="460" width="210" height="108" rx="6" fill="#fee2e2" stroke="#dc2626" stroke-width="1" opacity="0.6"/>
  <text x="70" y="478" fill="#991b1b" font-size="11" font-weight="bold">Fault Triggers (any state):</text>
  <text x="70" y="496" fill="#991b1b" font-size="10">Thermocouple fault / open</text>
  <text x="70" y="510" fill="#991b1b" font-size="10">Over-temperature (&gt; 165 C)</text>
  <text x="70" y="524" fill="#991b1b" font-size="10">Over-pressure (&gt; 15 bar)</text>
  <text x="70" y="538" fill="#991b1b" font-size="10">Sensor timeout (&gt; 500 ms)</text>
  <text x="70" y="552" fill="#991b1b" font-size="10">Stuck SSR / continuous heat &gt; 60s</text>
  <text x="70" y="566" fill="#991b1b" font-size="10">Control loop rate &lt; 10 Hz</text>

  <!-- ======= Legend ======= -->
  <rect x="60" y="640" width="880" height="40" rx="4" fill="white" stroke="#e2e8f0" stroke-width="1"/>
  <text x="80" y="662" fill="#0f172a" font-size="11" font-weight="bold">Legend:</text>

  <rect x="140" y="650" width="20" height="14" rx="3" fill="#f1f5f9" stroke="#334155" stroke-width="1.5"/>
  <text x="165" y="662" fill="#64748b" font-size="10">Idle</text>

  <rect x="200" y="650" width="20" height="14" rx="3" fill="#ffedd5" stroke="#334155" stroke-width="1.5"/>
  <text x="225" y="662" fill="#64748b" font-size="10">Heating</text>

  <rect x="280" y="650" width="20" height="14" rx="3" fill="#d1fae5" stroke="#334155" stroke-width="1.5"/>
  <text x="305" y="662" fill="#64748b" font-size="10">Ready/Done</text>

  <rect x="380" y="650" width="20" height="14" rx="3" fill="#dbeafe" stroke="#334155" stroke-width="1.5"/>
  <text x="405" y="662" fill="#64748b" font-size="10">Brewing</text>

  <rect x="460" y="650" width="20" height="14" rx="3" fill="#fef3c7" stroke="#334155" stroke-width="1.5"/>
  <text x="485" y="662" fill="#64748b" font-size="10">Steam</text>

  <rect x="530" y="650" width="20" height="14" rx="3" fill="#e0f2fe" stroke="#334155" stroke-width="1.5"/>
  <text x="555" y="662" fill="#64748b" font-size="10">Flushing</text>

  <rect x="610" y="650" width="20" height="14" rx="3" fill="#ede9fe" stroke="#334155" stroke-width="1.5"/>
  <text x="635" y="662" fill="#64748b" font-size="10">Descaling</text>

  <rect x="700" y="650" width="20" height="14" rx="3" fill="#fee2e2" stroke="#dc2626" stroke-width="1.5"/>
  <text x="725" y="662" fill="#64748b" font-size="10">Fault</text>

  <line x1="770" y1="657" x2="800" y2="657" stroke="#64748b" stroke-width="1.5" marker-end="url(#arrow-trans)"/>
  <text x="810" y="662" fill="#64748b" font-size="10">Transition</text>

  <line x1="870" y1="657" x2="900" y2="657" stroke="#dc2626" stroke-width="1.5" stroke-dasharray="4,3" marker-end="url(#arrow-fault)"/>
  <text x="910" y="662" fill="#64748b" font-size="10">Fault</text>
</svg>