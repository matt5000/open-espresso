<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 900 450" width="900" height="450">
  <style>
    text { font-family: 'Source Sans 3', sans-serif; }
    .mono { font-family: 'Source Code Pro', monospace; }
  </style>

  <defs>
    <marker id="arrow-data" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
      <path d="M0,0 L8,3 L0,6" fill="none" stroke="#3b82f6" stroke-width="1.5"/>
    </marker>
    <marker id="arrow-struct" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
      <path d="M0,0 L8,3 L0,6" fill="none" stroke="#64748b" stroke-width="1.5"/>
    </marker>
    <marker id="arrow-data-rev" markerWidth="8" markerHeight="6" refX="0" refY="3" orient="auto">
      <path d="M8,0 L0,3 L8,6" fill="none" stroke="#3b82f6" stroke-width="1.5"/>
    </marker>
  </defs>

  <!-- Background -->
  <rect width="900" height="450" fill="#f8fafc" rx="4"/>

  <!-- Title -->
  <text x="450" y="28" text-anchor="middle" fill="#0f172a" font-size="16" font-weight="bold">FreeRTOS Task Architecture -- ESP32-S3 Dual-Core</text>

  <!-- ======================== -->
  <!-- Core 0 column -->
  <!-- ======================== -->
  <rect x="30" y="44" width="380" height="392" rx="8" fill="white" stroke="#334155" stroke-width="2"/>
  <rect x="30" y="44" width="380" height="30" rx="8" fill="#dbeafe" stroke="#1e40af" stroke-width="2"/>
  <!-- cover bottom rounding on header -->
  <rect x="31" y="60" width="378" height="16" fill="#dbeafe"/>
  <line x1="31" y1="74" x2="409" y2="74" stroke="#1e40af" stroke-width="2"/>
  <text x="220" y="65" text-anchor="middle" fill="#1e40af" font-size="14" font-weight="bold">Core 0 -- Real-Time (pinned)</text>

  <!-- ControlTask box -->
  <rect x="50" y="86" width="340" height="175" rx="6" fill="#dbeafe" stroke="#1e40af" stroke-width="1.5"/>
  <text x="220" y="108" text-anchor="middle" fill="#1e40af" font-size="13" font-weight="bold">ControlTask</text>
  <text x="220" y="124" text-anchor="middle" class="mono" fill="#1e40af" font-size="11">5 ms period</text>
  <line x1="70" y1="132" x2="370" y2="132" stroke="#93c5fd" stroke-width="1"/>

  <text x="75" y="152" fill="#1e40af" font-size="12">1. Read sensors (temp, pressure, flow)</text>
  <text x="75" y="172" fill="#1e40af" font-size="12">2. Run PID algorithm</text>
  <text x="75" y="192" fill="#1e40af" font-size="12">3. Set pump power (dimmer duty)</text>
  <text x="75" y="212" fill="#1e40af" font-size="12">4. Set boiler SSR state</text>
  <text x="75" y="232" fill="#1e40af" font-size="12">5. Safety limit checks</text>

  <!-- Safety annotation -->
  <rect x="260" y="222" width="120" height="22" rx="4" fill="#fee2e2" stroke="#dc2626" stroke-width="1"/>
  <text x="320" y="238" text-anchor="middle" fill="#991b1b" font-size="10" font-weight="bold">Trip if exceeded</text>

  <!-- DimmerISR box -->
  <rect x="50" y="274" width="340" height="58" rx="6" fill="#dbeafe" stroke="#1e40af" stroke-width="1.5"/>
  <text x="220" y="296" text-anchor="middle" fill="#1e40af" font-size="13" font-weight="bold">DimmerISR</text>
  <text x="220" y="312" text-anchor="middle" class="mono" fill="#1e40af" font-size="11">Hardware timer -- Zero-cross + phase-angle firing</text>

  <!-- WatchdogTask box -->
  <rect x="50" y="344" width="340" height="80" rx="6" fill="#fee2e2" stroke="#dc2626" stroke-width="2"/>
  <text x="220" y="366" text-anchor="middle" fill="#991b1b" font-size="13" font-weight="bold">WatchdogTask</text>
  <line x1="70" y1="374" x2="370" y2="374" stroke="#fca5a5" stroke-width="1"/>
  <text x="220" y="393" text-anchor="middle" fill="#991b1b" font-size="12">Feed hardware watchdog timer</text>
  <text x="220" y="411" text-anchor="middle" fill="#991b1b" font-size="12">Reset MCU if ControlTask stalls</text>

  <!-- ======================== -->
  <!-- Core 1 column -->
  <!-- ======================== -->
  <rect x="490" y="44" width="380" height="392" rx="8" fill="white" stroke="#334155" stroke-width="2"/>
  <rect x="490" y="44" width="380" height="30" rx="8" fill="white" stroke="#334155" stroke-width="2"/>
  <!-- cover bottom rounding on header -->
  <rect x="491" y="60" width="378" height="16" fill="white"/>
  <line x1="491" y1="74" x2="869" y2="74" stroke="#334155" stroke-width="2"/>
  <text x="680" y="65" text-anchor="middle" fill="#0f172a" font-size="14" font-weight="bold">Core 1 -- Application</text>

  <!-- UITask box -->
  <rect x="510" y="86" width="340" height="157" rx="6" fill="white" stroke="#334155" stroke-width="1.5"/>
  <text x="680" y="108" text-anchor="middle" fill="#0f172a" font-size="13" font-weight="bold">UITask</text>
  <text x="680" y="124" text-anchor="middle" class="mono" fill="#64748b" font-size="11">50 ms period</text>
  <line x1="530" y1="132" x2="830" y2="132" stroke="#e2e8f0" stroke-width="1"/>
  <text x="530" y="152" fill="#0f172a" font-size="12">Web server (HTTP + REST API)</text>
  <text x="530" y="172" fill="#0f172a" font-size="12">WebSocket push (real-time data)</text>
  <text x="530" y="192" fill="#0f172a" font-size="12">Display update (LVGL)</text>
  <text x="530" y="212" fill="#0f172a" font-size="12">Profile editor interface</text>

  <!-- BLETask box -->
  <rect x="510" y="256" width="340" height="76" rx="6" fill="white" stroke="#334155" stroke-width="1.5"/>
  <text x="680" y="278" text-anchor="middle" fill="#0f172a" font-size="13" font-weight="bold">BLETask</text>
  <line x1="530" y1="286" x2="830" y2="286" stroke="#e2e8f0" stroke-width="1"/>
  <text x="530" y="306" fill="#0f172a" font-size="12">Scale weight reading</text>
  <text x="530" y="322" fill="#0f172a" font-size="12">Connection heartbeat management</text>

  <!-- PersistenceTask box -->
  <rect x="510" y="344" width="340" height="80" rx="6" fill="white" stroke="#334155" stroke-width="1.5"/>
  <text x="680" y="366" text-anchor="middle" fill="#0f172a" font-size="13" font-weight="bold">PersistenceTask</text>
  <line x1="530" y1="374" x2="830" y2="374" stroke="#e2e8f0" stroke-width="1"/>
  <text x="530" y="393" fill="#0f172a" font-size="12">Config save (NVS)</text>
  <text x="530" y="411" fill="#0f172a" font-size="12">Shot logging (LittleFS)</text>

  <!-- ======================== -->
  <!-- Queue arrows between cores -->
  <!-- ======================== -->

  <!-- ControlTask -> UITask queue -->
  <line x1="390" y1="140" x2="510" y2="140" stroke="#3b82f6" stroke-width="1.5" marker-end="url(#arrow-data)"/>

  <!-- UITask -> ControlTask queue (profile commands) -->
  <line x1="510" y1="165" x2="390" y2="165" stroke="#3b82f6" stroke-width="1.5" marker-end="url(#arrow-data-rev)"/>

  <!-- ControlTask -> PersistenceTask queue -->
  <line x1="390" y1="210" x2="460" y2="210" stroke="#3b82f6" stroke-width="1.5"/>
  <line x1="460" y1="210" x2="460" y2="384" stroke="#3b82f6" stroke-width="1.5"/>
  <line x1="460" y1="384" x2="510" y2="384" stroke="#3b82f6" stroke-width="1.5" marker-end="url(#arrow-data)"/>

  <!-- BLETask -> ControlTask queue -->
  <line x1="510" y1="300" x2="470" y2="300" stroke="#3b82f6" stroke-width="1.5"/>
  <line x1="470" y1="300" x2="470" y2="230" stroke="#3b82f6" stroke-width="1.5"/>
  <line x1="470" y1="230" x2="390" y2="230" stroke="#3b82f6" stroke-width="1.5" marker-end="url(#arrow-data-rev)"/>

  <!-- Queues label box -->
  <rect x="418" y="88" width="64" height="26" rx="4" fill="#f8fafc" stroke="#3b82f6" stroke-width="1.5" stroke-dasharray="4,3"/>
  <text x="450" y="106" text-anchor="middle" fill="#3b82f6" font-size="11" font-weight="bold">Queues</text>
</svg>
