<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 900 500" width="900" height="500">
  <style>
    text { font-family: 'Source Sans 3', sans-serif; }
    .mono { font-family: 'Source Code Pro', monospace; }
  </style>

  <defs>
    <marker id="arrow-struct" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
      <path d="M0,0 L8,3 L0,6" fill="none" stroke="#64748b" stroke-width="1.5"/>
    </marker>
    <marker id="arrow-data" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
      <path d="M0,0 L8,3 L0,6" fill="none" stroke="#3b82f6" stroke-width="1.5"/>
    </marker>
    <marker id="arrow-struct-rev" markerWidth="8" markerHeight="6" refX="0" refY="3" orient="auto">
      <path d="M8,0 L0,3 L8,6" fill="none" stroke="#64748b" stroke-width="1.5"/>
    </marker>
  </defs>

  <!-- Background -->
  <rect width="900" height="500" fill="#f8fafc" rx="4"/>

  <!-- Title -->
  <text x="450" y="28" text-anchor="middle" fill="#0f172a" font-size="16" font-weight="bold">System Context: Open Espresso Firmware</text>

  <!-- ======= Central firmware box ======= -->
  <rect x="250" y="55" width="400" height="280" rx="8" fill="white" stroke="#334155" stroke-width="2"/>
  <text x="450" y="78" text-anchor="middle" fill="#0f172a" font-size="14" font-weight="bold">Open Espresso Firmware (ESP32-S3)</text>
  <line x1="270" y1="88" x2="630" y2="88" stroke="#e2e8f0" stroke-width="1"/>

  <!-- Internal modules -->
  <!-- Sensors -->
  <rect x="272" y="100" width="110" height="40" rx="5" fill="#dbeafe" stroke="#1e40af" stroke-width="2"/>
  <text x="327" y="124" text-anchor="middle" fill="#1e40af" font-size="12" font-weight="bold">Sensors</text>

  <!-- Arrow: Sensors → Control -->
  <line x1="382" y1="120" x2="393" y2="120" stroke="#3b82f6" stroke-width="1.5" marker-end="url(#arrow-data)"/>

  <!-- Control -->
  <rect x="400" y="100" width="110" height="40" rx="5" fill="#dbeafe" stroke="#1e40af" stroke-width="2"/>
  <text x="455" y="124" text-anchor="middle" fill="#1e40af" font-size="12" font-weight="bold">Control</text>

  <!-- Safety -->
  <rect x="525" y="100" width="110" height="40" rx="5" fill="#fee2e2" stroke="#dc2626" stroke-width="2"/>
  <text x="580" y="124" text-anchor="middle" fill="#991b1b" font-size="12" font-weight="bold">Safety</text>

  <!-- Arrow: Control → Safety -->
  <line x1="510" y1="120" x2="521" y2="120" stroke="#3b82f6" stroke-width="1.5" marker-end="url(#arrow-data)"/>

  <!-- Display -->
  <rect x="272" y="160" width="110" height="40" rx="5" fill="#dbeafe" stroke="#1e40af" stroke-width="2"/>
  <text x="327" y="184" text-anchor="middle" fill="#1e40af" font-size="12" font-weight="bold">Display</text>

  <!-- BLE -->
  <rect x="400" y="160" width="110" height="40" rx="5" fill="#dbeafe" stroke="#1e40af" stroke-width="2"/>
  <text x="455" y="184" text-anchor="middle" fill="#1e40af" font-size="12" font-weight="bold">BLE</text>

  <!-- Persist -->
  <rect x="525" y="160" width="110" height="40" rx="5" fill="#dbeafe" stroke="#1e40af" stroke-width="2"/>
  <text x="580" y="184" text-anchor="middle" fill="#1e40af" font-size="12" font-weight="bold">Persist</text>

  <!-- Web Server -->
  <rect x="272" y="220" width="236" height="40" rx="5" fill="#dbeafe" stroke="#1e40af" stroke-width="2"/>
  <text x="390" y="244" text-anchor="middle" fill="#1e40af" font-size="12" font-weight="bold">Web Server (REST / WebSocket)</text>

  <!-- OTA -->
  <rect x="525" y="220" width="110" height="40" rx="5" fill="#dbeafe" stroke="#1e40af" stroke-width="2"/>
  <text x="580" y="244" text-anchor="middle" fill="#1e40af" font-size="12" font-weight="bold">OTA</text>

  <!-- Profile Engine -->
  <rect x="272" y="280" width="175" height="36" rx="5" fill="#dbeafe" stroke="#1e40af" stroke-width="2"/>
  <text x="360" y="302" text-anchor="middle" fill="#1e40af" font-size="12" font-weight="bold">Profile Engine</text>

  <!-- HAL -->
  <rect x="462" y="280" width="175" height="36" rx="5" fill="white" stroke="#334155" stroke-width="2" stroke-dasharray="4,3"/>
  <text x="550" y="302" text-anchor="middle" fill="#334155" font-size="12" font-weight="bold">HAL (abstraction)</text>

  <!-- ======= External: Gaggia Classic (left) ======= -->
  <rect x="15" y="90" width="170" height="130" rx="8" fill="white" stroke="#334155" stroke-width="2"/>
  <text x="100" y="115" text-anchor="middle" fill="#0f172a" font-size="13" font-weight="bold">Gaggia Classic</text>
  <text x="100" y="132" text-anchor="middle" fill="#64748b" font-size="11">(Machine)</text>
  <line x1="35" y1="140" x2="165" y2="140" stroke="#e2e8f0" stroke-width="1"/>
  <text x="100" y="159" text-anchor="middle" fill="#0f172a" font-size="11">Thermocouple</text>
  <text x="100" y="175" text-anchor="middle" fill="#0f172a" font-size="11">Pressure transducer</text>
  <text x="100" y="191" text-anchor="middle" fill="#0f172a" font-size="11">Flow sensor</text>
  <text x="100" y="207" text-anchor="middle" fill="#0f172a" font-size="11">SSR / Dimmer / Valve</text>

  <!-- Arrows: Machine ↔ Firmware -->
  <line x1="185" y1="135" x2="248" y2="120" stroke="#64748b" stroke-width="1.5" marker-end="url(#arrow-struct)"/>
  <text x="210" y="118" fill="#64748b" font-size="10">sensors in</text>
  <line x1="248" y1="150" x2="185" y2="175" stroke="#64748b" stroke-width="1.5" marker-end="url(#arrow-struct)"/>
  <text x="200" y="170" fill="#64748b" font-size="10">actuators out</text>

  <!-- Mains AC label -->
  <text x="100" y="242" text-anchor="middle" fill="#991b1b" font-size="11" font-weight="bold">Mains AC</text>
  <text x="100" y="256" text-anchor="middle" fill="#991b1b" font-size="10">(230V / 120V)</text>

  <!-- ======= External: Browser/Phone (right) ======= -->
  <rect x="715" y="90" width="170" height="100" rx="8" fill="white" stroke="#334155" stroke-width="2"/>
  <text x="800" y="118" text-anchor="middle" fill="#0f172a" font-size="13" font-weight="bold">Browser / Phone</text>
  <text x="800" y="135" text-anchor="middle" fill="#64748b" font-size="11">(Web App)</text>
  <line x1="735" y1="143" x2="865" y2="143" stroke="#e2e8f0" stroke-width="1"/>
  <text x="800" y="162" text-anchor="middle" fill="#0f172a" font-size="11">Dashboard / Config</text>
  <text x="800" y="178" text-anchor="middle" fill="#0f172a" font-size="11">Shot history / Profiles</text>

  <!-- Arrow: Firmware ↔ Browser -->
  <line x1="650" y1="140" x2="712" y2="140" stroke="#3b82f6" stroke-width="1.5" marker-end="url(#arrow-data)"/>
  <text x="680" y="132" fill="#3b82f6" font-size="10">WiFi</text>
  <text x="680" y="156" fill="#3b82f6" font-size="10">REST / WS</text>

  <!-- ======= External: BLE Scales (bottom-right) ======= -->
  <rect x="715" y="255" width="170" height="60" rx="8" fill="white" stroke="#334155" stroke-width="2"/>
  <text x="800" y="280" text-anchor="middle" fill="#0f172a" font-size="13" font-weight="bold">BLE Scales</text>
  <text x="800" y="300" text-anchor="middle" fill="#64748b" font-size="11">(Acaia, Decent, Felicita...)</text>

  <!-- Arrow: BLE Scales → Firmware -->
  <line x1="715" y1="285" x2="652" y2="185" stroke="#3b82f6" stroke-width="1.5" marker-end="url(#arrow-data)"/>
  <text x="700" y="230" fill="#3b82f6" font-size="10">BLE</text>

  <!-- ======= External Libraries (bottom) ======= -->
  <rect x="140" y="380" width="620" height="100" rx="8" fill="white" stroke="#334155" stroke-width="2" stroke-dasharray="6,3"/>
  <text x="450" y="400" text-anchor="middle" fill="#0f172a" font-size="13" font-weight="bold">External Libraries / Dependencies</text>
  <line x1="160" y1="408" x2="740" y2="408" stroke="#e2e8f0" stroke-width="1"/>

  <!-- Library items -->
  <rect x="162" y="420" width="100" height="28" rx="4" fill="#f1f5f9" stroke="#94a3b8" stroke-width="1"/>
  <text x="212" y="439" text-anchor="middle" fill="#334155" font-size="11">FreeRTOS</text>

  <rect x="278" y="420" width="86" height="28" rx="4" fill="#f1f5f9" stroke="#94a3b8" stroke-width="1"/>
  <text x="321" y="439" text-anchor="middle" fill="#334155" font-size="11">LVGL</text>

  <rect x="380" y="420" width="140" height="28" rx="4" fill="#f1f5f9" stroke="#94a3b8" stroke-width="1"/>
  <text x="450" y="439" text-anchor="middle" fill="#334155" font-size="11">ESPAsyncWebServer</text>

  <rect x="536" y="420" width="86" height="28" rx="4" fill="#f1f5f9" stroke="#94a3b8" stroke-width="1"/>
  <text x="579" y="439" text-anchor="middle" fill="#334155" font-size="11">NimBLE</text>

  <rect x="638" y="420" width="100" height="28" rx="4" fill="#f1f5f9" stroke="#94a3b8" stroke-width="1"/>
  <text x="688" y="439" text-anchor="middle" fill="#334155" font-size="11">LittleFS</text>

  <rect x="162" y="456" width="100" height="28" rx="4" fill="#f1f5f9" stroke="#94a3b8" stroke-width="1"/>
  <text x="212" y="475" text-anchor="middle" fill="#334155" font-size="11">ESP-IDF</text>

  <rect x="278" y="456" width="86" height="28" rx="4" fill="#f1f5f9" stroke="#94a3b8" stroke-width="1"/>
  <text x="321" y="475" text-anchor="middle" fill="#334155" font-size="11">ArduinoJSON</text>

  <!-- Arrow: Libraries → Firmware -->
  <line x1="450" y1="378" x2="450" y2="340" stroke="#64748b" stroke-width="1.5" marker-end="url(#arrow-struct)"/>
  <text x="465" y="365" fill="#64748b" font-size="10">linked</text>
</svg>