<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1300 1050" font-family="'Courier New', monospace" font-size="12">
  <title>Open Espresso — Modified Electrical Schematic (Gaggia Classic Pre-2015, EU 230V)</title>
  <style>
    .wire { stroke: #333; stroke-width: 2; fill: none; }
    .wire-live { stroke: #b33; stroke-width: 2.5; fill: none; }
    .wire-neutral { stroke: #339; stroke-width: 2.5; fill: none; }
    .wire-earth { stroke: #393; stroke-width: 2.5; fill: none; stroke-dasharray: 6,3; }
    .wire-signal { stroke: #96f; stroke-width: 2; fill: none; stroke-dasharray: 4,2; }
    .wire-5v { stroke: #d70; stroke-width: 2; fill: none; }
    .component { fill: #f8f8f0; stroke: #333; stroke-width: 1.5; }
    .component-safety { fill: #fff0f0; stroke: #b33; stroke-width: 2; }
    .component-new { fill: #e8f4e8; stroke: #2a7; stroke-width: 2; }
    .component-removed { fill: #f0f0f0; stroke: #aaa; stroke-width: 1.5; stroke-dasharray: 5,3; }
    .component-switch { fill: #f0f0ff; stroke: #333; stroke-width: 1.5; }
    .component-mcu { fill: #e0e8ff; stroke: #46a; stroke-width: 2; }
    .label { font-size: 11px; fill: #333; font-family: 'Helvetica Neue', Arial, sans-serif; }
    .label-bold { font-size: 11px; fill: #333; font-weight: bold; font-family: 'Helvetica Neue', Arial, sans-serif; }
    .label-small { font-size: 9px; fill: #666; font-family: 'Helvetica Neue', Arial, sans-serif; }
    .label-new { font-size: 9px; fill: #2a7; font-weight: bold; font-family: 'Helvetica Neue', Arial, sans-serif; }
    .label-removed { font-size: 9px; fill: #999; font-style: italic; font-family: 'Helvetica Neue', Arial, sans-serif; }
    .title { font-size: 18px; fill: #111; font-weight: bold; font-family: 'Helvetica Neue', Arial, sans-serif; }
    .subtitle { font-size: 13px; fill: #555; font-family: 'Helvetica Neue', Arial, sans-serif; }
    .legend-box { fill: #fafafa; stroke: #ccc; stroke-width: 1; }
    .node { fill: #333; }
    .heater-fill { fill: #ffd6cc; stroke: #c44; stroke-width: 2; }
    .zone-inside { fill: #faf8f4; stroke: #c9b89a; stroke-width: 1; stroke-dasharray: 8,4; }
    .zone-outside { fill: #f4f8fa; stroke: #89a9c9; stroke-width: 1; stroke-dasharray: 8,4; }
  </style>

  <rect width="1300" height="1050" fill="#fefefe"/>

  <!-- Title -->
  <text x="650" y="35" text-anchor="middle" class="title">Open Espresso — Modified Electrical Schematic</text>
  <text x="650" y="55" text-anchor="middle" class="subtitle">Gaggia Classic (Pre-2015) EU 230V — After Modification</text>

  <!-- Legend -->
  <rect x="20" y="70" width="370" height="130" class="legend-box" rx="4"/>
  <text x="30" y="88" class="label-bold">Legend</text>
  <line x1="30" y1="102" x2="70" y2="102" class="wire-live"/>
  <text x="76" y="106" class="label">Live (L) — Mains AC</text>
  <line x1="30" y1="118" x2="70" y2="118" class="wire-neutral"/>
  <text x="76" y="122" class="label">Neutral (N) — Mains AC</text>
  <line x1="30" y1="134" x2="70" y2="134" class="wire-earth"/>
  <text x="76" y="138" class="label">Earth (E) — Protective ground</text>
  <line x1="30" y1="150" x2="70" y2="150" class="wire-signal"/>
  <text x="76" y="154" class="label">Signal (3.3V logic) — to/from ESP32</text>
  <line x1="30" y1="166" x2="70" y2="166" class="wire-5v"/>
  <text x="76" y="170" class="label">5V DC power</text>
  <rect x="220" y="95" width="60" height="16" class="component-new" rx="2"/>
  <text x="288" y="107" class="label-new">NEW component</text>
  <rect x="220" y="115" width="60" height="16" class="component-removed" rx="2"/>
  <text x="288" y="127" class="label-removed">REMOVED component</text>
  <rect x="220" y="135" width="60" height="16" class="component-mcu" rx="2"/>
  <text x="288" y="147" class="label" fill="#46a">ESP32 / electronics</text>
  <circle cx="240" cy="168" r="4" class="node"/>
  <text x="252" y="172" class="label">Junction point</text>

  <!-- ==================== ZONE: Inside Machine ==================== -->
  <rect x="15" y="210" width="780" height="720" class="zone-inside" rx="8"/>
  <text x="25" y="230" class="label-bold" fill="#8a7040">INSIDE MACHINE (Gaggia chassis)</text>

  <!-- ==================== ZONE: External Enclosure ==================== -->
  <rect x="820" y="210" width="460" height="720" class="zone-outside" rx="8"/>
  <text x="830" y="230" class="label-bold" fill="#406080">EXTERNAL ENCLOSURE (rear-mounted)</text>

  <!-- ==================== IEC INLET ==================== -->
  <rect x="30" y="260" width="100" height="80" class="component" rx="4"/>
  <text x="80" y="285" text-anchor="middle" class="label-bold">IEC C14</text>
  <text x="80" y="300" text-anchor="middle" class="label-bold">Inlet</text>
  <text x="80" y="318" text-anchor="middle" class="label-small">230V AC</text>

  <!-- ==================== LIVE PATH ==================== -->
  <line x1="130" y1="272" x2="190" y2="272" class="wire-live"/>

  <!-- Power Switch -->
  <rect x="190" y="255" width="90" height="35" class="component-switch" rx="4"/>
  <text x="235" y="277" text-anchor="middle" class="label-bold">Power SW</text>
  <line x1="280" y1="272" x2="340" y2="272" class="wire-live"/>
  <circle cx="340" cy="272" r="4" class="node"/>
  <text x="345" y="262" class="label-small">Switched Live</text>

  <!-- ==================== REMOVED: Brew + Steam Thermostats ==================== -->
  <rect x="160" y="350" width="130" height="40" class="component-removed" rx="4"/>
  <text x="225" y="368" text-anchor="middle" class="label-removed">Brew thermostat</text>
  <text x="225" y="380" text-anchor="middle" class="label-removed">REMOVED</text>
  <line x1="225" y1="340" x2="225" y2="350" stroke="#aaa" stroke-width="1" stroke-dasharray="3,3"/>
  <line x1="225" y1="390" x2="225" y2="400" stroke="#aaa" stroke-width="1" stroke-dasharray="3,3"/>

  <rect x="160" y="410" width="130" height="40" class="component-removed" rx="4"/>
  <text x="225" y="428" text-anchor="middle" class="label-removed">Steam thermostat</text>
  <text x="225" y="440" text-anchor="middle" class="label-removed">REMOVED</text>

  <!-- ==================== SSR (replaces brew thermostat) ==================== -->
  <!-- Switched live to SSR -->
  <line x1="340" y1="272" x2="340" y2="400" class="wire-live"/>

  <rect x="310" y="400" width="100" height="50" class="component-new" rx="4"/>
  <text x="360" y="420" text-anchor="middle" class="label-bold">SSR</text>
  <text x="360" y="434" text-anchor="middle" class="label-bold">40A</text>
  <text x="360" y="392" text-anchor="middle" class="label-new">NEW — replaces thermostats</text>
  <text x="360" y="462" text-anchor="middle" class="label-small">GPIO39 control (3.3V)</text>

  <!-- SSR signal wire to enclosure -->
  <line x1="410" y1="425" x2="500" y2="425" class="wire-signal"/>
  <text x="450" y="418" class="label-small">SSR ctrl</text>

  <!-- ==================== THERMAL FUSE (SAFETY) ==================== -->
  <!-- SSR output to thermal fuse -->
  <line x1="360" y1="450" x2="360" y2="510" class="wire-live"/>

  <rect x="300" y="510" width="120" height="45" class="component-safety" rx="4"/>
  <text x="360" y="530" text-anchor="middle" class="label-bold">Thermal Fuse</text>
  <text x="360" y="543" text-anchor="middle" class="label-small">184°C, 16A, one-shot</text>
  <text x="360" y="500" text-anchor="middle" class="label-small" fill="#b33">SAFETY-CRITICAL (new fuse, upper slot)</text>
  <text x="360" y="566" text-anchor="middle" class="label-small">Upper thermostat slot</text>

  <!-- Thermal fuse to boiler -->
  <line x1="360" y1="555" x2="360" y2="610" class="wire-live"/>

  <!-- ==================== BOILER ==================== -->
  <rect x="295" y="610" width="130" height="55" class="heater-fill" rx="4"/>
  <text x="360" y="632" text-anchor="middle" class="label-bold">Boiler Heater</text>
  <text x="360" y="647" text-anchor="middle" class="label-bold">Element</text>
  <text x="360" y="678" text-anchor="middle" class="label-small">2× in series (230V)</text>

  <!-- Boiler neutral side -->
  <line x1="425" y1="637" x2="480" y2="637" class="wire-neutral"/>

  <!-- ==================== THERMOCOUPLE (on boiler) ==================== -->
  <rect x="295" y="700" width="130" height="40" class="component-new" rx="4"/>
  <text x="360" y="718" text-anchor="middle" class="label-bold">K-Type Thermocouple</text>
  <text x="360" y="730" text-anchor="middle" class="label-small">M4, lower thermostat slot</text>
  <text x="360" y="692" text-anchor="middle" class="label-new">NEW sensor</text>
  <!-- TC signal to enclosure -->
  <line x1="425" y1="720" x2="500" y2="720" class="wire-signal"/>
  <text x="450" y="712" class="label-small">TC 2-wire</text>

  <!-- ==================== NEUTRAL PATH ==================== -->
  <line x1="130" y1="298" x2="160" y2="298" class="wire-neutral"/>
  <line x1="160" y1="298" x2="160" y2="637" class="wire-neutral"/>
  <!-- Neutral bus -->
  <line x1="160" y1="637" x2="295" y2="637" class="wire-neutral"/>
  <circle cx="480" cy="637" r="4" class="node"/>
  <text x="485" y="632" class="label-small">N bus</text>

  <!-- ==================== DIMMER + PUMP ==================== -->
  <!-- Switched live to brew switch -->
  <line x1="340" y1="272" x2="560" y2="272" class="wire-live"/>

  <!-- Brew Switch -->
  <rect x="560" y="255" width="90" height="35" class="component-switch" rx="4"/>
  <text x="605" y="277" text-anchor="middle" class="label-bold">Brew SW</text>
  <text x="605" y="248" text-anchor="middle" class="label-small">Retained from stock</text>

  <!-- Brew switch output -->
  <line x1="650" y1="272" x2="700" y2="272" class="wire-live"/>
  <circle cx="700" cy="272" r="4" class="node"/>

  <!-- Down to dimmer -->
  <line x1="700" y1="272" x2="700" y2="350" class="wire-live"/>

  <!-- AC Dimmer Module -->
  <rect x="620" y="350" width="160" height="60" class="component-new" rx="4"/>
  <text x="700" y="373" text-anchor="middle" class="label-bold">AC Dimmer Module</text>
  <text x="700" y="388" text-anchor="middle" class="label-small">Zero-cross + triac</text>
  <text x="700" y="400" text-anchor="middle" class="label-small">EMI filter + snubber</text>
  <text x="700" y="342" text-anchor="middle" class="label-new">NEW — in series with pump</text>
  <!-- Dimmer signal wires to enclosure -->
  <line x1="780" y1="375" x2="810" y2="375" class="wire-signal"/>
  <text x="748" y="420" class="label-small">GPIO40 ZC in, GPIO41 gate out</text>

  <!-- Dimmer output to pump -->
  <line x1="700" y1="410" x2="700" y2="470" class="wire-live"/>

  <!-- Pump -->
  <rect x="650" y="470" width="100" height="50" class="component" rx="4"/>
  <text x="700" y="492" text-anchor="middle" class="label-bold">Ulka EP5</text>
  <text x="700" y="506" text-anchor="middle" class="label-bold">Pump</text>
  <text x="700" y="462" text-anchor="middle" class="label-small">Stock pump retained</text>

  <!-- Flow sensor after pump -->
  <line x1="700" y1="520" x2="700" y2="560" class="wire"/>
  <rect x="650" y="560" width="100" height="40" class="component-new" rx="4"/>
  <text x="700" y="578" text-anchor="middle" class="label-bold">Flow Sensor</text>
  <text x="700" y="590" text-anchor="middle" class="label-small">Hall-effect, inline</text>
  <text x="700" y="552" text-anchor="middle" class="label-new">NEW sensor</text>
  <!-- Flow signal to enclosure -->
  <line x1="750" y1="580" x2="810" y2="580" class="wire-signal"/>
  <text x="755" y="572" class="label-small">Flow 3-wire</text>

  <!-- Pump neutral -->
  <line x1="700" y1="600" x2="700" y2="637" class="wire-neutral"/>
  <line x1="480" y1="637" x2="700" y2="637" class="wire-neutral"/>
  <circle cx="700" cy="637" r="4" class="node"/>

  <!-- ==================== SOLENOID ==================== -->
  <!-- From brew switch output right -->
  <line x1="700" y1="272" x2="740" y2="272" class="wire-live"/>
  <line x1="740" y1="272" x2="740" y2="780" class="wire-live"/>

  <!-- Solenoid -->
  <rect x="650" y="780" width="120" height="50" class="component" rx="4"/>
  <text x="710" y="802" text-anchor="middle" class="label-bold">3-Way Solenoid</text>
  <text x="710" y="816" text-anchor="middle" class="label-small">Stock retained</text>
  <text x="710" y="772" text-anchor="middle" class="label-small">Optional GPIO42 control</text>
  <line x1="740" y1="830" x2="740" y2="860" class="wire-neutral"/>
  <line x1="480" y1="860" x2="740" y2="860" class="wire-neutral"/>
  <line x1="480" y1="637" x2="480" y2="860" class="wire-neutral"/>
  <!-- Solenoid signal -->
  <line x1="770" y1="800" x2="810" y2="800" class="wire-signal"/>
  <text x="755" y="840" class="label-small">Solenoid ctrl</text>

  <!-- ==================== PRESSURE TRANSDUCER ==================== -->
  <rect x="480" y="780" width="130" height="40" class="component-new" rx="4"/>
  <text x="545" y="798" text-anchor="middle" class="label-bold">Pressure Transducer</text>
  <text x="545" y="810" text-anchor="middle" class="label-small">0-1.2 MPa, T-fitting</text>
  <text x="545" y="772" text-anchor="middle" class="label-new">NEW sensor</text>
  <!-- Pressure signal to enclosure -->
  <line x1="610" y1="800" x2="810" y2="800" class="wire-signal" style="stroke-dasharray:4,2"/>
  <text x="680" y="790" class="label-small">Pressure 3-wire</text>

  <!-- ==================== 5V PSU ==================== -->
  <rect x="60" y="480" width="100" height="50" class="component-new" rx="4"/>
  <text x="110" y="500" text-anchor="middle" class="label-bold">5V PSU</text>
  <text x="110" y="514" text-anchor="middle" class="label-small">Hi-Link HLK-PM01</text>
  <text x="110" y="472" text-anchor="middle" class="label-new">NEW — AC to 5V DC</text>
  <!-- PSU AC input from switched live -->
  <line x1="160" y1="298" x2="60" y2="298" class="wire-neutral"/>
  <line x1="60" y1="298" x2="60" y2="480" class="wire-neutral"/>
  <line x1="160" y1="272" x2="160" y2="340" class="wire"/>
  <line x1="110" y1="340" x2="160" y2="340" class="wire-live"/>
  <line x1="110" y1="340" x2="110" y2="480" class="wire-live"/>
  <!-- PSU 5V output to enclosure -->
  <line x1="160" y1="505" x2="500" y2="505" class="wire-5v"/>
  <text x="300" y="498" class="label-small">5V DC to enclosure</text>

  <!-- ==================== EARTH PATH ==================== -->
  <line x1="130" y1="322" x2="160" y2="322" class="wire-earth"/>
  <line x1="160" y1="322" x2="160" y2="900" class="wire-earth"/>
  <rect x="100" y="885" width="130" height="30" rx="4" fill="#e8ffe8" stroke="#393" stroke-width="1.5"/>
  <text x="165" y="905" text-anchor="middle" class="label-bold" fill="#263">Chassis Ground</text>
  <text x="165" y="878" text-anchor="middle" class="label-small">DO NOT interrupt stock earth</text>

  <!-- ==================== CABLE GLAND BOUNDARY ==================== -->
  <line x1="808" y1="240" x2="808" y2="910" stroke="#999" stroke-width="1.5" stroke-dasharray="2,4"/>
  <text x="808" y="920" text-anchor="middle" class="label-small" fill="#666">Cable glands (PG7/PG9) through rear panel</text>

  <!-- Signal wires cross the boundary -->
  <!-- SSR ctrl -->
  <line x1="500" y1="425" x2="850" y2="425" class="wire-signal"/>
  <!-- TC -->
  <line x1="500" y1="720" x2="850" y2="720" class="wire-signal"/>
  <!-- Flow -->
  <line x1="810" y1="580" x2="850" y2="580" class="wire-signal"/>
  <!-- Dimmer -->
  <line x1="810" y1="375" x2="850" y2="375" class="wire-signal"/>
  <!-- Solenoid -->
  <line x1="810" y1="800" x2="850" y2="800" class="wire-signal"/>
  <!-- 5V -->
  <line x1="500" y1="505" x2="850" y2="505" class="wire-5v"/>
  <!-- Pressure -->

  <!-- ==================== ESP32-S3 (External Enclosure) ==================== -->
  <rect x="880" y="300" width="340" height="370" class="component-mcu" rx="6"/>
  <text x="1050" y="325" text-anchor="middle" class="label-bold" font-size="14" fill="#335">ESP32-S3</text>
  <text x="1050" y="342" text-anchor="middle" class="label-small">WROOM-1 / WROVER (N16R8)</text>

  <!-- GPIO labels inside ESP32 box -->
  <!-- SSR -->
  <line x1="850" y1="425" x2="880" y2="425" class="wire-signal"/>
  <text x="890" y="428" class="label-small">GPIO39 → SSR ctrl (OUT)</text>

  <!-- Dimmer ZC + Gate -->
  <line x1="850" y1="375" x2="880" y2="375" class="wire-signal"/>
  <text x="890" y="371" class="label-small">GPIO40 ← Zero-cross (IN)</text>
  <text x="890" y="384" class="label-small">GPIO41 → Triac gate (OUT)</text>

  <!-- Flow -->
  <line x1="850" y1="580" x2="880" y2="580" class="wire-signal"/>
  <text x="890" y="583" class="label-small">GPIO16 ← Flow pulse (IN/ISR)</text>

  <!-- Brew switch sense -->
  <text x="890" y="470" class="label-small">GPIO2 ← Brew switch (IN)</text>
  <text x="890" y="485" class="label-small">GPIO1 ← Steam switch (IN)</text>

  <!-- Solenoid -->
  <line x1="850" y1="800" x2="880" y2="510" class="wire-signal"/>
  <text x="890" y="513" class="label-small">GPIO42 → Solenoid ctrl (OUT)</text>

  <!-- BLE -->
  <text x="890" y="545" class="label-small">BLE → External scale (wireless)</text>

  <!-- WiFi -->
  <text x="890" y="565" class="label-small">WiFi → Web UI / OTA updates</text>

  <!-- SPI/I2C buses -->
  <text x="890" y="610" class="label-small">SPI2 → TFT Display (ILI9341)</text>
  <text x="890" y="625" class="label-small">SPI3 → MAX31855 (thermocouple)</text>
  <text x="890" y="640" class="label-small">I2C0 → CST816 (touch)</text>
  <text x="890" y="655" class="label-small">I2C1 → ADS1115 (pressure ADC)</text>

  <!-- ==================== SENSOR BREAKOUTS (External Enclosure) ==================== -->
  <!-- MAX31855 -->
  <rect x="880" y="700" width="120" height="40" class="component-new" rx="4"/>
  <text x="940" y="718" text-anchor="middle" class="label-bold">MAX31855</text>
  <text x="940" y="730" text-anchor="middle" class="label-small">SPI thermocouple IC</text>
  <line x1="850" y1="720" x2="880" y2="720" class="wire-signal"/>

  <!-- ADS1115 -->
  <rect x="1040" y="700" width="120" height="40" class="component-new" rx="4"/>
  <text x="1100" y="718" text-anchor="middle" class="label-bold">ADS1115</text>
  <text x="1100" y="730" text-anchor="middle" class="label-small">I2C pressure ADC</text>
  <line x1="850" y1="800" x2="1040" y2="756" class="wire-signal" style="stroke-dasharray:4,2"/>

  <!-- TFT Display -->
  <rect x="880" y="770" width="160" height="50" class="component-new" rx="4"/>
  <text x="960" y="792" text-anchor="middle" class="label-bold">ILI9341 2.8" TFT</text>
  <text x="960" y="806" text-anchor="middle" class="label-small">SPI + CST816 touch (I2C)</text>

  <!-- 3.3V LDO -->
  <rect x="1080" y="770" width="100" height="50" class="component-new" rx="4"/>
  <text x="1130" y="792" text-anchor="middle" class="label-bold">3.3V LDO</text>
  <text x="1130" y="806" text-anchor="middle" class="label-small">AMS1117-3.3</text>

  <!-- 5V power into enclosure -->
  <line x1="850" y1="505" x2="880" y2="505" class="wire-5v"/>
  <text x="890" y="502" class="label-small">5V in from PSU</text>

  <!-- ==================== PULL-DOWN RESISTORS NOTE ==================== -->
  <rect x="880" y="850" width="340" height="55" rx="4" fill="#fff8f0" stroke="#c93" stroke-width="1"/>
  <text x="890" y="868" class="label-bold" fill="#964">Safety: Pull-Down Resistors</text>
  <text x="890" y="883" class="label-small">10kΩ on GPIO39 (SSR), GPIO41 (dimmer), GPIO42 (solenoid)</text>
  <text x="890" y="896" class="label-small">Ensures all actuators OFF during MCU reset / boot</text>

  <!-- ==================== VERSION NOTE ==================== -->
  <text x="650" y="980" text-anchor="middle" class="label-small">Open Espresso Project — docs/diagrams/modified-wiring.svg</text>
  <text x="650" y="995" text-anchor="middle" class="label-small">Green-bordered components are NEW. Dashed-bordered components are REMOVED from stock.</text>
  <text x="650" y="1010" text-anchor="middle" class="label-small">All signal wires are 3.3V logic level. Verify all connections with multimeter before powering on.</text>
</svg>
