<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 700 420" width="700" height="420">
  <style>
    text { font-family: 'Source Sans 3', sans-serif; }
    .mono { font-family: 'Source Code Pro', monospace; font-size: 12px; }
  </style>
  <rect width="700" height="420" fill="#f8fafc" rx="4"/>
  <text x="350" y="26" text-anchor="middle" fill="#0f172a" font-size="16" font-weight="bold">STM32 Software Architecture (Current)</text>
  <!-- Root -->
  <rect x="20" y="42" width="300" height="30" rx="5" fill="#dbeafe" stroke="#1e40af" stroke-width="2"/>
  <text x="170" y="62" text-anchor="middle" class="mono" fill="#1e40af" font-weight="bold">Main Loop (gaggiuino.cpp)</text>
  <!-- Trunk line -->
  <line x1="40" y1="72" x2="40" y2="395" stroke="#64748b" stroke-width="1.5"/>
  <!-- Branch 1: sensorsRead() -->
  <circle cx="40" cy="95" r="3" fill="#64748b"/>
  <line x1="40" y1="95" x2="70" y2="95" stroke="#64748b" stroke-width="1.5"/>
  <rect x="70" y="80" width="180" height="30" rx="5" fill="white" stroke="#334155" stroke-width="1.5"/>
  <text x="160" y="100" text-anchor="middle" class="mono" fill="#0f172a">sensorsRead()</text>
  <line x1="250" y1="95" x2="280" y2="95" stroke="#64748b" stroke-width="1"/>
  <line x1="280" y1="80" x2="280" y2="140" stroke="#64748b" stroke-width="1"/>
  <line x1="280" y1="80" x2="300" y2="80" stroke="#64748b" stroke-width="1"/>
  <text x="310" y="84" fill="#64748b" font-size="11">Temperature (MAX31855)</text>
  <line x1="280" y1="100" x2="300" y2="100" stroke="#64748b" stroke-width="1"/>
  <text x="310" y="104" fill="#64748b" font-size="11">Pressure (0â€“12 bar analog)</text>
  <line x1="280" y1="120" x2="300" y2="120" stroke="#64748b" stroke-width="1"/>
  <text x="310" y="124" fill="#64748b" font-size="11">Flow (hall-effect pulse counter)</text>
  <!-- Branch 2: lcdRefresh() -->
  <circle cx="40" cy="155" r="3" fill="#64748b"/>
  <line x1="40" y1="155" x2="70" y2="155" stroke="#64748b" stroke-width="1.5"/>
  <rect x="70" y="140" width="180" height="30" rx="5" fill="white" stroke="#334155" stroke-width="1.5"/>
  <text x="160" y="160" text-anchor="middle" class="mono" fill="#0f172a">lcdRefresh()</text>
  <text x="270" y="160" fill="#64748b" font-size="11">Send state to ESP32 via UART</text>
  <!-- Branch 3: systemHealthCheck() -->
  <circle cx="40" cy="200" r="3" fill="#64748b"/>
  <line x1="40" y1="200" x2="70" y2="200" stroke="#64748b" stroke-width="1.5"/>
  <rect x="70" y="185" width="250" height="30" rx="5" fill="#fee2e2" stroke="#dc2626" stroke-width="1.5"/>
  <text x="195" y="205" text-anchor="middle" class="mono" fill="#991b1b">systemHealthCheck()</text>
  <line x1="320" y1="200" x2="350" y2="200" stroke="#64748b" stroke-width="1"/>
  <line x1="350" y1="190" x2="350" y2="215" stroke="#64748b" stroke-width="1"/>
  <line x1="350" y1="190" x2="370" y2="190" stroke="#64748b" stroke-width="1"/>
  <text x="380" y="194" fill="#991b1b" font-size="11">Thermocouple fault detection</text>
  <line x1="350" y1="210" x2="370" y2="210" stroke="#64748b" stroke-width="1"/>
  <text x="380" y="214" fill="#991b1b" font-size="11">Pressure sensor fault detection</text>
  <!-- Branch 4: State Machine -->
  <circle cx="40" cy="255" r="3" fill="#64748b"/>
  <line x1="40" y1="255" x2="70" y2="255" stroke="#64748b" stroke-width="1.5"/>
  <rect x="70" y="240" width="180" height="30" rx="5" fill="#dbeafe" stroke="#1e40af" stroke-width="2"/>
  <text x="160" y="260" text-anchor="middle" class="mono" fill="#1e40af" font-weight="bold">State Machine</text>
  <line x1="250" y1="255" x2="280" y2="255" stroke="#64748b" stroke-width="1"/>
  <line x1="280" y1="255" x2="280" y2="395" stroke="#64748b" stroke-width="1"/>
  <!-- BREW_MODE_4 -->
  <line x1="280" y1="275" x2="300" y2="275" stroke="#64748b" stroke-width="1"/>
  <rect x="300" y="262" width="200" height="26" rx="4" fill="#dbeafe" stroke="#1e40af" stroke-width="1.5"/>
  <text x="400" y="280" text-anchor="middle" class="mono" fill="#1e40af" font-size="11">BREW_MODE_4 (profiling)</text>
  <line x1="500" y1="275" x2="520" y2="275" stroke="#64748b" stroke-width="1"/>
  <line x1="520" y1="260" x2="520" y2="330" stroke="#64748b" stroke-width="1"/>
  <line x1="520" y1="260" x2="540" y2="260" stroke="#64748b" stroke-width="1"/>
  <text x="550" y="264" fill="#64748b" font-size="10">PhaseProfiler</text>
  <line x1="520" y1="278" x2="540" y2="278" stroke="#64748b" stroke-width="1"/>
  <text x="550" y="282" fill="#64748b" font-size="10">PID (pressure)</text>
  <line x1="520" y1="296" x2="540" y2="296" stroke="#64748b" stroke-width="1"/>
  <text x="550" y="300" fill="#64748b" font-size="10">PID (flow)</text>
  <line x1="520" y1="314" x2="540" y2="314" stroke="#64748b" stroke-width="1"/>
  <text x="550" y="318" fill="#64748b" font-size="10">PredictiveWeight</text>
  <!-- FLUSH_MODE -->
  <line x1="280" y1="340" x2="300" y2="340" stroke="#64748b" stroke-width="1"/>
  <rect x="300" y="327" width="200" height="26" rx="4" fill="white" stroke="#334155" stroke-width="1.5"/>
  <text x="400" y="345" text-anchor="middle" class="mono" fill="#0f172a" font-size="11">FLUSH_MODE</text>
  <!-- DESCALE_MODE -->
  <line x1="280" y1="365" x2="300" y2="365" stroke="#64748b" stroke-width="1"/>
  <rect x="300" y="352" width="200" height="26" rx="4" fill="white" stroke="#334155" stroke-width="1.5"/>
  <text x="400" y="370" text-anchor="middle" class="mono" fill="#0f172a" font-size="11">DESCALE_MODE</text>
  <!-- STEAM_MODE -->
  <line x1="280" y1="390" x2="300" y2="390" stroke="#64748b" stroke-width="1"/>
  <rect x="300" y="377" width="200" height="26" rx="4" fill="white" stroke="#334155" stroke-width="1.5"/>
  <text x="400" y="395" text-anchor="middle" class="mono" fill="#0f172a" font-size="11">STEAM_MODE</text>
  <text x="520" y="395" fill="#64748b" font-size="10">PID (temperature)</text>
</svg>
